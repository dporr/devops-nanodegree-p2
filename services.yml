Description: >
    Diego Porras. Project 2 services
    This was created following along the course and editing the necesary
    parts for project submission.
Parameters:
  EnvironmentName:
      Description: Single Parameter that we are passing with the env name.
      Type: String
      Default: Project2
  InstanceType:
    Description: Instance type for ec2 resource allocation
    Type: String
    Default: t3.medium
  AmiId:
    Description: AMI id. Default ubuntu 18.04 LTS
    Type: String
    Default: ami-005bdb005fb00e791

Resources:
  HTTPSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
      Properties:
        GroupDescription: SG for the Web Server
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            CidrIp: 0.0.0.0/0
            FromPort: 80
            ToPort: 80

  SSHSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
      Properties:
        GroupDescription: SG for allowing SSH traffic
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            CidrIp: 0.0.0.0/0
            FromPort: 22
            ToPort: 22

  ServerUpdatesSG:
    Type: 'AWS::EC2::SecurityGroup'
      Properties:
        GroupDescription: SG for allowing external traffic for software updates
        VpcId: !Ref VPC
        SecurityGroupEgress:
          - IpProtocol: tcp
            CidrIp: 0.0.0.0/0
            FromPort: 0
            ToPort: 65535

  LBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow http to our load balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0

  LoadBalancer:
  AutoscalingGroup:
  S3ReadOnlyInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: 
      Roles: S3ReadOnlyAccessRole
  
  WebAppLaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      UserData:
        Fn::Base64: !Sub |
        #!/bin/bash
        apt-get update -y
        apt-get install apache2 unzip awscli -y
        systemctl start apache2.service
        cd /var/www/html
        #aws s3 cp s3://project2-bucket-dporras/udacity.zip .
        #unzip -o udacity.zip
        echo "it works! Udagram, Udacity" > index.html
      ImageId: !Ref AmiId
      IamInstanceProfile: !Ref S3ReadOnlyInstanceProfile
      SecurityGroupIds:
        - !Ref HTTPSecurityGroup
        - !Ref SSHSecurityGroup
        - !Ref ServerUpdatesSG
      InstanceType: !Ref InstanceType
      BlockDeviceMappings:
      - DeviceName: "/dev/sdk"
        Ebs:
          VolumeSize: '10'
  BastionHost1:
